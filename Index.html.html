<!-- 
  GENDER UNIT WORK PLAN 2026 - GANTT CHART TOOL
  
  INSTRUCTIONS:
  1. Download this file as "chart.html".
  2. Save it to your Shared Folder / Idocs location.
  3. Everyone opens it from there. 
  4. NOTE: Changes save to your LOCAL browser. To share updates, one person should manage the master updates, 
     or you will need to Copy/Paste the 'Data Code' from the Manage menu to share progress.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gender Unit Work Plan 2026</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        #loading-message { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #64748b; font-family: sans-serif; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen overflow-hidden">

    <div id="root" class="h-full">
        <div id="loading-message">
            <h2 class="text-xl font-bold mb-2">Loading Work Plan...</h2>
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto mb-4"></div>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- ICONS ---
        const Icon = ({ path, className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>;
        const CalendarIcon = (p) => <Icon {...p} path={<><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></>} />;
        const FileTextIcon = (p) => <Icon {...p} path={<><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/></>} />;
        const FilterIcon = (p) => <Icon {...p} path={<><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></>} />;
        const EditIcon = (p) => <Icon {...p} path={<><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></>} />;
        const TrashIcon = (p) => <Icon {...p} path={<><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></>} />;
        const PlusIcon = (p) => <Icon {...p} path={<><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></>} />;
        const XIcon = (p) => <Icon {...p} path={<><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></>} />;
        const ChevronDownIcon = (p) => <Icon {...p} path={<path d="m6 9 6 6 6-6"/>} />;
        const ClipboardIcon = (p) => <Icon {...p} path={<><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></>} />;
        const CheckCircleIcon = (p) => <Icon {...p} path={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>} />;
        const UsersIcon = (p) => <Icon {...p} path={<><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>} />;
        const SettingsIcon = (p) => <Icon {...p} path={<><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></>} />;
        const SendIcon = (p) => <Icon {...p} path={<><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></>} />;
        const CodeIcon = (p) => <Icon {...p} path={<><polyline points="16 18 22 12 16 6" /><polyline points="8 6 2 12 8 18" /></>} />;

        // --- Constants ---
        const MONTHS = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const CATEGORY_COLORS = {
            'Coordination': 'bg-blue-200 text-blue-800 border-blue-300',
            'Technical work': 'bg-emerald-200 text-emerald-800 border-emerald-300',
            'Workshops / meetings': 'bg-amber-200 text-amber-800 border-amber-300',
            'Reporting': 'bg-purple-200 text-purple-800 border-purple-300',
        };
        const CATEGORY_BAR_COLORS = {
            'Coordination': 'bg-blue-500',
            'Technical work': 'bg-emerald-500',
            'Workshops / meetings': 'bg-amber-500',
            'Reporting': 'bg-purple-500',
        };
        const STATUS_COLORS = {
            'Not Started': 'bg-slate-100 text-slate-500 border-slate-200',
            'In Progress': 'bg-blue-50 text-blue-600 border-blue-200',
            'Completed': 'bg-green-50 text-green-600 border-green-200',
            'Delayed': 'bg-red-50 text-red-600 border-red-200',
        };

        // --- HARDCODED INITIAL DATA (From your Excel) ---
        const DEFAULT_DATA = [
            {
                activityName: "1.1.8. kNOwVAWdata initiative",
                subActivities: [
                    { 
                        id: "1-1", 
                        description: "Upload the kNOwVAWdata curriculum to an online learning platform", 
                        category: "Technical work", 
                        responsible: "Abeer", 
                        months: [3, 4, 5], 
                        weeks: [12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23], 
                        parentActivity: "1.1.8. kNOwVAWdata initiative", 
                        status: "Not Started", 
                        notes: [] 
                    },
                    { 
                        id: "1-2", 
                        description: "Enable regional access and use by Country Offices and partners", 
                        category: "Coordination", 
                        responsible: "Abeer", 
                        months: [3, 4, 5], 
                        weeks: [12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23], 
                        parentActivity: "1.1.8. kNOwVAWdata initiative", 
                        status: "Not Started", 
                        notes: [] 
                    }
                ]
            },
            {
                activityName: "5.1.2: Strengthening Essential Services Package (ESP)",
                subActivities: [
                    { 
                        id: "5-1", 
                        description: "Convene a virtual regional ESP consultation with Country Offices", 
                        category: "Workshops / meetings", 
                        responsible: "Abeer", 
                        months: [0, 1, 2], 
                        weeks: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11], 
                        parentActivity: "5.1.2: Strengthening Essential Services Package (ESP)", 
                        status: "Not Started", 
                        notes: [] 
                    },
                    { 
                        id: "5-2", 
                        description: "Present consolidated findings from the 2025 ESP CO Survey", 
                        category: "Reporting", 
                        responsible: "Abeer", 
                        months: [0, 1, 2], 
                        weeks: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11], 
                        parentActivity: "5.1.2: Strengthening Essential Services Package (ESP)", 
                        status: "Not Started", 
                        notes: [] 
                    },
                    { 
                        id: "5-3", 
                        description: "Identify regional priorities and partnership opportunities", 
                        category: "Coordination", 
                        responsible: "Abeer", 
                        months: [0, 1, 2], 
                        weeks: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11], 
                        parentActivity: "5.1.2: Strengthening Essential Services Package (ESP)", 
                        status: "Not Started", 
                        notes: [] 
                    },
                    { 
                        id: "5-4", 
                        description: "Support COs to strengthen and rollout of the ESP", 
                        category: "Technical work", 
                        responsible: "Abeer", 
                        months: [0, 1, 2, 9, 10, 11], 
                        weeks: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47], 
                        parentActivity: "5.1.2: Strengthening Essential Services Package (ESP)", 
                        status: "Not Started", 
                        notes: [] 
                    }
                ]
            }
        ];
        
        const DEFAULT_TEAM = ['Bothaina', 'Abeer', 'Shadia', 'Rania'];

        // --- Safe Storage Wrapper ---
        const safeStorage = {
            getItem: (key) => {
                try { return localStorage.getItem(key); } catch (e) { return null; }
            },
            setItem: (key, value) => {
                try { localStorage.setItem(key, value); } catch (e) { console.warn('Storage failed', e); }
            }
        };

        // --- COMPONENTS ---

        function EditModal({ isOpen, onClose, onSave, onImport, taskToEdit, teamMembers, onManageTeam, existingGroups, currentData }) {
            const [activeTab, setActiveTab] = useState(taskToEdit ? 'manual' : 'manual');
            const [pasteContent, setPasteContent] = useState('');
            const [newTeamMember, setNewTeamMember] = useState('');
            const [isCreatingGroup, setIsCreatingGroup] = useState(false);
            const [copyStatus, setCopyStatus] = useState('');
            
            const [formState, setFormState] = useState({ 
                description: '', 
                responsible: teamMembers[0] || '', 
                category: 'Coordination', 
                parentActivity: '',
                selectedWeeks: new Set() 
            });

            useEffect(() => {
                if (isOpen) {
                    if (taskToEdit) {
                        const initialWeeks = new Set(taskToEdit.weeks || []);
                        if (initialWeeks.size === 0 && taskToEdit.months) {
                            taskToEdit.months.forEach(m => {
                                initialWeeks.add(m*4); initialWeeks.add(m*4+1); initialWeeks.add(m*4+2); initialWeeks.add(m*4+3);
                            });
                        }
                        setFormState({
                            description: taskToEdit.description,
                            responsible: taskToEdit.responsible,
                            category: taskToEdit.category,
                            parentActivity: taskToEdit.parentActivity,
                            selectedWeeks: initialWeeks
                        });
                        setIsCreatingGroup(false);
                        setActiveTab('manual');
                    } else {
                        setFormState({ 
                            description: '', 
                            responsible: teamMembers[0] || '', 
                            category: 'Coordination', 
                            parentActivity: existingGroups[0] || '', 
                            selectedWeeks: new Set() 
                        });
                        setIsCreatingGroup(existingGroups.length === 0);
                    }
                }
            }, [isOpen, taskToEdit, teamMembers, existingGroups]);

            if (!isOpen) return null;

            const toggleWeek = (weekIdx) => {
                const newSet = new Set(formState.selectedWeeks);
                if (newSet.has(weekIdx)) newSet.delete(weekIdx);
                else newSet.add(weekIdx);
                setFormState({ ...formState, selectedWeeks: newSet });
            };

            const toggleMonth = (monthIdx) => {
                const startWeek = monthIdx * 4;
                const newSet = new Set(formState.selectedWeeks);
                let allSelected = true;
                for(let i=0; i<4; i++) { if(!newSet.has(startWeek + i)) allSelected = false; }
                for(let i=0; i<4; i++) {
                    if (allSelected) newSet.delete(startWeek + i);
                    else newSet.add(startWeek + i);
                }
                setFormState({ ...formState, selectedWeeks: newSet });
            };

            const handleSave = () => {
                if (!formState.description) { alert("Please enter a sub-activity description."); return; }
                if (!formState.parentActivity) { alert("Please specify a Main Activity (Group)."); return; }
                
                const weeksArr = Array.from(formState.selectedWeeks).sort((a,b) => a-b);
                const monthsSet = new Set();
                weeksArr.forEach(w => monthsSet.add(Math.floor(w/4)));
                const monthsArr = Array.from(monthsSet).sort((a,b) => a-b);

                const task = {
                    id: taskToEdit ? taskToEdit.id : Date.now().toString(),
                    description: formState.description,
                    category: formState.category,
                    responsible: formState.responsible,
                    months: monthsArr,
                    weeks: weeksArr,
                    parentActivity: formState.parentActivity,
                    status: taskToEdit ? taskToEdit.status : 'Not Started',
                    notes: taskToEdit ? taskToEdit.notes : []
                };
                onSave(task, !!taskToEdit);
                if(!taskToEdit) {
                    setFormState(prev => ({ ...prev, description: '', selectedWeeks: new Set() }));
                } else onClose();
            };

            const handleTextExport = () => {
                const dataStr = JSON.stringify({ data: currentData, teamMembers, timestamp: new Date().toISOString() });
                navigator.clipboard.writeText(dataStr).then(() => {
                    setCopyStatus('Copied!');
                    setTimeout(() => setCopyStatus(''), 2000);
                });
            };

            const handleTextImport = () => {
                if (!pasteContent) return;
                onImport(pasteContent);
                setPasteContent('');
                onClose();
            };

            const handleAddTeamMember = () => {
                if(newTeamMember && !teamMembers.includes(newTeamMember)) {
                    onManageTeam('add', newTeamMember);
                    setNewTeamMember('');
                }
            };

            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-xl w-full max-w-3xl max-h-[90vh] flex flex-col">
                        <div className="flex justify-between items-center p-6 border-b border-slate-100">
                            <h2 className="text-xl font-bold text-slate-800">{taskToEdit ? 'Edit Activity Details' : 'Manage Data'}</h2>
                            <button onClick={onClose}><XIcon className="w-6 h-6 text-slate-400 hover:text-slate-600" /></button>
                        </div>
                        
                        <div className="flex border-b border-slate-100 px-6 bg-slate-50">
                            <button onClick={() => setActiveTab('manual')} className={`py-3 px-4 text-sm font-medium border-b-2 flex items-center gap-2 ${activeTab === 'manual' ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-slate-500 hover:text-slate-700'}`}>
                                <EditIcon className="w-4 h-4"/> {taskToEdit ? 'Activity Details' : 'Add Activity'}
                            </button>
                            {!taskToEdit && (
                                <>
                                    <button onClick={() => setActiveTab('team')} className={`py-3 px-4 text-sm font-medium border-b-2 flex items-center gap-2 ${activeTab === 'team' ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-slate-500 hover:text-slate-700'}`}>
                                        <UsersIcon className="w-4 h-4"/> Team
                                    </button>
                                    <button onClick={() => setActiveTab('backup')} className={`py-3 px-4 text-sm font-medium border-b-2 flex items-center gap-2 ${activeTab === 'backup' ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-slate-500 hover:text-slate-700'}`}>
                                        <CodeIcon className="w-4 h-4"/> Backup
                                    </button>
                                </>
                            )}
                        </div>

                        <div className="p-6 overflow-y-auto flex-1">
                            {activeTab === 'manual' && (
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-xs font-semibold text-slate-500 uppercase mb-1">Sub-Activity (Task)</label>
                                        <input type="text" className="w-full border border-slate-300 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-indigo-500" value={formState.description} onChange={e => setFormState({...formState, description: e.target.value})} placeholder="e.g., Organize regional workshop..." />
                                    </div>
                                    
                                    <div>
                                        <label className="block text-xs font-semibold text-slate-500 uppercase mb-1">Main Activity (Group)</label>
                                        {isCreatingGroup ? (
                                            <div className="flex gap-2">
                                                <input type="text" className="w-full border border-slate-300 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-indigo-500" placeholder="Enter new Main Activity name..." value={formState.parentActivity} onChange={e => setFormState({...formState, parentActivity: e.target.value})} autoFocus />
                                                <button onClick={() => { setIsCreatingGroup(false); setFormState({...formState, parentActivity: existingGroups[0] || ''}); }} className="text-xs text-slate-500 underline whitespace-nowrap px-2">Cancel</button>
                                            </div>
                                        ) : (
                                            <select className="w-full border border-slate-300 rounded-lg p-2.5 text-sm" value={formState.parentActivity} onChange={e => {
                                                    if(e.target.value === '___NEW___') {
                                                        setIsCreatingGroup(true);
                                                        setFormState({...formState, parentActivity: ''});
                                                    } else {
                                                        setFormState({...formState, parentActivity: e.target.value});
                                                    }
                                                }}>
                                                {existingGroups.map(g => <option key={g} value={g}>{g}</option>)}
                                                <option value="___NEW___" className="font-bold text-indigo-600">+ Create New Main Activity...</option>
                                            </select>
                                        )}
                                    </div>

                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-xs font-semibold text-slate-500 uppercase mb-1">Responsible</label>
                                            <select className="w-full border border-slate-300 rounded-lg p-2.5 text-sm" value={formState.responsible} onChange={e => setFormState({...formState, responsible: e.target.value})}>
                                                {teamMembers.map(n => <option key={n} value={n}>{n}</option>)}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-semibold text-slate-500 uppercase mb-1">Category</label>
                                            <select className="w-full border border-slate-300 rounded-lg p-2.5 text-sm" value={formState.category} onChange={e => setFormState({...formState, category: e.target.value})}>
                                                {Object.keys(CATEGORY_COLORS).map(c => <option key={c} value={c}>{c}</option>)}
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-semibold text-slate-500 uppercase mb-2">Schedule (Weekly)</label>
                                        <div className="border border-slate-200 rounded-lg overflow-hidden">
                                            <div className="grid grid-cols-6 bg-slate-50 border-b border-slate-200">
                                                {['Q1', 'Q2', 'Q3', 'Q4'].map((q) => <div key={q} className="col-span-3 p-1 text-center text-xs font-bold text-slate-500 border-r last:border-r-0 border-slate-200">{q}</div>)}
                                            </div>
                                            <div className="grid grid-cols-3 sm:grid-cols-4 gap-2 p-2 max-h-48 overflow-y-auto">
                                                {MONTHS.map((m, mIdx) => (
                                                    <div key={m} className="border border-slate-100 rounded p-2 bg-slate-50/50">
                                                        <div className="flex justify-between items-center mb-1 cursor-pointer hover:bg-slate-100 rounded px-1" onClick={() => toggleMonth(mIdx)}>
                                                            <span className="text-xs font-bold text-slate-700">{m}</span>
                                                            <span className="text-[10px] text-indigo-600">All</span>
                                                        </div>
                                                        <div className="grid grid-cols-4 gap-1">
                                                            {[0,1,2,3].map(w => {
                                                                const weekIdx = mIdx * 4 + w;
                                                                const isSelected = formState.selectedWeeks.has(weekIdx);
                                                                return <div key={w} onClick={() => toggleWeek(weekIdx)} className={`h-5 flex items-center justify-center text-[9px] rounded cursor-pointer transition-colors ${isSelected ? 'bg-indigo-600 text-white' : 'bg-white border border-slate-200 text-slate-400 hover:border-indigo-300'}`} title={`Week ${w+1} of ${m}`}>W{w+1}</div>;
                                                            })}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                    <button onClick={handleSave} className="w-full bg-indigo-600 text-white font-medium py-2.5 rounded-lg hover:bg-indigo-700 flex items-center justify-center gap-2">
                                        {taskToEdit ? <><CheckCircleIcon className="w-4 h-4"/> Update Activity</> : <><PlusIcon className="w-4 h-4"/> Add Activity</>}
                                    </button>
                                </div>
                            )}

                            {activeTab === 'team' && (
                                <div className="space-y-6">
                                    <div className="bg-slate-50 p-4 rounded-lg border border-slate-200">
                                        <label className="block text-xs font-semibold text-slate-500 uppercase mb-2">Add New Member</label>
                                        <div className="flex gap-2">
                                            <input type="text" className="flex-1 border border-slate-300 rounded-lg p-2 text-sm" placeholder="Name..." value={newTeamMember} onChange={e => setNewTeamMember(e.target.value)} />
                                            <button onClick={handleAddTeamMember} className="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-green-700">Add</button>
                                        </div>
                                    </div>
                                    <div className="space-y-2">
                                        {teamMembers.map(member => (
                                            <div key={member} className="flex items-center justify-between p-3 bg-white border border-slate-200 rounded-lg shadow-sm">
                                                <span className="text-sm font-medium text-slate-700">{member}</span>
                                                <button onClick={() => onManageTeam('remove', member)} className="text-slate-400 hover:text-red-500 p-1"><TrashIcon className="w-4 h-4" /></button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {activeTab === 'backup' && (
                                <div className="space-y-6">
                                    <div className="bg-amber-50 border border-amber-100 p-4 rounded-lg">
                                        <h3 className="font-bold text-amber-800 text-sm mb-2">Transfer Data</h3>
                                        <p className="text-xs text-amber-700 mb-3">Use this to move data between computers or to back up your progress manually.</p>
                                        <button onClick={handleTextExport} className="bg-white border border-amber-300 text-amber-800 px-3 py-1.5 rounded text-xs font-bold hover:bg-amber-100 flex items-center gap-2 w-full justify-center">
                                            <ClipboardIcon className="w-3 h-3"/> Copy All Data Code {copyStatus && `- ${copyStatus}`}
                                        </button>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-semibold text-slate-500 uppercase mb-2">Paste Data Code to Load</label>
                                        <textarea className="w-full h-32 border border-slate-300 rounded-lg p-3 text-xs font-mono focus:ring-2 focus:ring-indigo-500" placeholder='Paste data code here...' value={pasteContent} onChange={e => setPasteContent(e.target.value)}></textarea>
                                        <button onClick={handleTextImport} className="w-full bg-indigo-600 text-white font-medium py-2 rounded-lg hover:bg-indigo-700 mt-2">Load</button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        function MonitorModal({ task, onClose, onUpdate }) {
            const [status, setStatus] = useState(task.status || 'Not Started');
            const [newNote, setNewNote] = useState('');
            const scrollRef = useRef(null);
            const notesHistory = Array.isArray(task.notes) ? task.notes : (task.notes ? [{date: 'Previous', text: task.notes}] : []);

            const handleSave = () => {
                let updatedNotes = [...notesHistory];
                if (newNote.trim()) {
                    const today = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    updatedNotes.unshift({ date: today, text: newNote.trim() });
                }
                onUpdate(task.id, status, updatedNotes);
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-xl w-full max-w-lg flex flex-col max-h-[90vh]">
                        <div className="flex justify-between items-center p-6 border-b border-slate-100">
                            <h2 className="text-lg font-bold text-slate-800 flex items-center gap-2"><ClipboardIcon className="w-5 h-5 text-indigo-600" /> Weekly Reporting</h2>
                            <button onClick={onClose}><XIcon className="w-6 h-6 text-slate-400 hover:text-slate-600" /></button>
                        </div>
                        <div className="p-6 space-y-6 overflow-y-auto">
                            <div>
                                <h3 className="text-xs font-semibold text-slate-500 uppercase mb-2">Activity</h3>
                                <p className="text-slate-800 bg-slate-50 p-3 rounded-lg border border-slate-200 text-sm leading-relaxed">{task.description}</p>
                            </div>
                            <div>
                                <label className="block text-xs font-semibold text-slate-500 uppercase mb-2">Current Status</label>
                                <div className="grid grid-cols-2 gap-3">
                                    {Object.keys(STATUS_COLORS).map(s => (
                                        <button key={s} onClick={() => setStatus(s)} className={`flex items-center justify-center px-3 py-2 rounded-lg border text-sm font-medium transition-all ${status === s ? STATUS_COLORS[s] + ' ring-2 ring-offset-1 ring-indigo-200 shadow-sm' : 'bg-white border-slate-200 text-slate-600 hover:bg-slate-50'}`}>{s}</button>
                                    ))}
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs font-semibold text-slate-500 uppercase mb-2">New Progress Update</label>
                                <div className="flex gap-2">
                                    <input type="text" className="flex-1 border border-slate-300 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-indigo-500" placeholder="e.g., Week 1: Completed draft..." value={newNote} onChange={(e) => setNewNote(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleSave()} />
                                    <button onClick={handleSave} className="bg-indigo-600 text-white px-4 rounded-lg hover:bg-indigo-700"><SendIcon className="w-4 h-4" /></button>
                                </div>
                            </div>
                            <div className="border-t border-slate-100 pt-4">
                                <label className="block text-xs font-semibold text-slate-500 uppercase mb-3">Progress History</label>
                                <div className="space-y-3 max-h-48 overflow-y-auto pr-2" ref={scrollRef}>
                                    {notesHistory.length > 0 ? notesHistory.map((note, i) => (
                                        <div key={i} className="flex gap-3 text-sm">
                                            <span className="text-xs font-mono text-slate-400 min-w-[60px] pt-0.5">{note.date}</span>
                                            <p className="text-slate-700 bg-slate-50 p-2 rounded-lg rounded-tl-none border border-slate-100 flex-1">{note.text}</p>
                                        </div>
                                    )) : <p className="text-xs text-slate-400 italic text-center py-2">No updates recorded yet.</p>}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function GanttRow({ task, onDelete, onMonitor, onEdit, timelineMode }) {
            const statusClass = STATUS_COLORS[task.status || 'Not Started'];
            
            return (
                <div className="flex border-b border-slate-100 hover:bg-slate-50 transition-colors group text-sm relative">
                    <div className="absolute left-1 top-1/2 -translate-y-1/2 z-10 flex flex-col gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                         <button onClick={() => onEdit(task)} className="p-1.5 bg-white border border-slate-200 text-blue-600 rounded shadow-sm hover:bg-blue-50" title="Edit Details"><EditIcon className="w-3.5 h-3.5" /></button>
                        <button onClick={() => onMonitor(task)} className="p-1.5 bg-white border border-slate-200 text-indigo-600 rounded shadow-sm hover:bg-indigo-50" title="Weekly Report"><ClipboardIcon className="w-3.5 h-3.5" /></button>
                         <button onClick={() => onDelete(task.id)} className="p-1.5 bg-white border border-slate-200 text-slate-400 rounded shadow-sm hover:text-red-500 hover:bg-red-50" title="Delete task"><TrashIcon className="w-3.5 h-3.5" /></button>
                    </div>

                    <div className="w-1/3 min-w-[300px] p-3 pl-10 border-r border-slate-200 flex flex-col justify-center">
                        <div className="flex items-start gap-2 mb-1">
                            <div className={`mt-1 min-w-[8px] h-2 rounded-full ${CATEGORY_BAR_COLORS[task.category]}`}></div>
                            <span className="text-slate-700 leading-snug cursor-pointer hover:text-indigo-600" onClick={() => onEdit(task)}>{task.description}</span>
                        </div>
                        <div className="flex items-center gap-2 ml-4">
                            <span className={`text-[10px] uppercase font-bold tracking-wide px-1.5 py-0.5 rounded ${CATEGORY_COLORS[task.category]}`}>{task.category}</span>
                            <span className={`text-[10px] font-medium px-2 py-0.5 rounded-full border flex items-center gap-1 cursor-pointer hover:brightness-95 ${statusClass}`} onClick={() => onMonitor(task)}>
                                {task.status === 'Completed' && <CheckCircleIcon className="w-3 h-3" />}
                                {task.status || 'Not Started'}
                            </span>
                            {(task.notes && task.notes.length > 0) && (
                                <span className="text-[10px] text-slate-400 flex items-center gap-0.5 bg-slate-100 px-1.5 py-0.5 rounded"><FileTextIcon className="w-3 h-3" /> {task.notes.length}</span>
                            )}
                        </div>
                    </div>

                    <div className="w-24 p-3 border-r border-slate-200 flex flex-col items-center justify-center text-center">
                        <div className="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center text-slate-600 text-xs font-bold mb-1">{task.responsible.substring(0,2).toUpperCase()}</div>
                        <span className="text-xs text-slate-600 font-medium truncate w-full">{task.responsible}</span>
                    </div>

                    <div className="flex-1 flex relative overflow-hidden">
                        {timelineMode === 'weeks' ? (
                            MONTHS.map((m, i) => (
                                <div key={m} className="flex-1 flex border-r border-slate-200 h-full">
                                    {[0,1,2,3].map(w => <div key={w} className="flex-1 border-r border-slate-100 last:border-none bg-opacity-10"></div>)}
                                </div>
                            ))
                        ) : (
                            MONTHS.map((_, i) => <div key={i} className={`flex-1 border-r border-slate-100 h-full ${i % 3 === 2 ? 'border-r-slate-200 bg-slate-50/30' : ''}`} />)
                        )}

                        {/* Render Bars */}
                        {timelineMode === 'months' ? (
                            task.months.length > 0 && task.months.map(monthIndex => (
                                <div key={monthIndex} className={`absolute top-3 bottom-3 rounded-sm opacity-90 shadow-sm ${CATEGORY_BAR_COLORS[task.category]} ${task.status === 'Completed' ? 'saturate-50 opacity-60' : ''}`}
                                    style={{ left: `${(monthIndex / 12) * 100}%`, width: `calc(${(1 / 12) * 100}% - 2px)`, marginLeft: '1px' }}
                                    title={`${task.category} - ${MONTHS[monthIndex]}`}
                                />
                            ))
                        ) : (
                            task.weeks && task.weeks.length > 0 ? task.weeks.map(weekIndex => (
                                <div key={weekIndex} className={`absolute top-3 bottom-3 rounded-sm opacity-90 shadow-sm ${CATEGORY_BAR_COLORS[task.category]} ${task.status === 'Completed' ? 'saturate-50 opacity-60' : ''}`}
                                    style={{ left: `${(weekIndex / 48) * 100}%`, width: `calc(${(1 / 48) * 100}% - 1px)`, marginLeft: '0.5px' }}
                                    title={`${task.category} - Week ${weekIndex+1}`}
                                />
                            )) : null
                        )}
                    </div>
                </div>
            );
        }

        function App() {
            // Initialize with saved data OR fall back to the provided Excel Data
            const [data, setData] = useState(() => {
                const saved = safeStorage.getItem('gender_workplan_data');
                return saved ? JSON.parse(saved) : DEFAULT_DATA;
            });
            const [teamMembers, setTeamMembers] = useState(() => {
                const saved = safeStorage.getItem('gender_workplan_team');
                return saved ? JSON.parse(saved) : DEFAULT_TEAM;
            });

            const [viewMode, setViewMode] = useState('grouped');
            const [timelineMode, setTimelineMode] = useState('months'); 
            const [personFilter, setPersonFilter] = useState('All');
            const [categoryFilter, setCategoryFilter] = useState('All');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [monitoringTask, setMonitoringTask] = useState(null);
            const [editingTask, setEditingTask] = useState(null);

            const existingGroups = useMemo(() => {
                const groups = new Set();
                data.forEach(d => groups.add(d.activityName));
                return Array.from(groups);
            }, [data]);

            useEffect(() => { safeStorage.setItem('gender_workplan_data', JSON.stringify(data)); }, [data]);
            useEffect(() => { safeStorage.setItem('gender_workplan_team', JSON.stringify(teamMembers)); }, [teamMembers]);

            // Manual Text Import for "offline" sharing
            const handleTextImport = (text) => {
                try {
                    const imported = JSON.parse(text);
                    if (imported.data && Array.isArray(imported.data)) {
                        setData(imported.data);
                        if(imported.teamMembers) setTeamMembers(imported.teamMembers);
                        alert("Data updated successfully!");
                    } else { alert("Invalid data format."); }
                } catch (e) { alert("Error parsing code."); }
            };

            const handleSaveTask = (task, isUpdate) => {
                if (isUpdate) {
                    setData(prev => prev.map(group => ({
                        ...group,
                        subActivities: group.subActivities.map(t => t.id === task.id ? task : t)
                    })));
                } else {
                    setData(prev => {
                        const newData = [...prev];
                        let parentGroup = newData.find(g => g.activityName === task.parentActivity);
                        if (!parentGroup) {
                            parentGroup = { activityName: task.parentActivity, subActivities: [] };
                            newData.push(parentGroup);
                        }
                        parentGroup.subActivities.push(task);
                        return newData;
                    });
                }
            };

            const handleManageTeam = (action, name) => {
                if (action === 'add') setTeamMembers(prev => [...prev, name]);
                if (action === 'remove') setTeamMembers(prev => prev.filter(n => n !== name));
            };

            const handleUpdateStatus = (taskId, newStatus, newNotes) => {
                setData(prev => prev.map(group => ({
                    ...group,
                    subActivities: group.subActivities.map(task => 
                        task.id === taskId ? { ...task, status: newStatus, notes: newNotes } : task
                    )
                })));
            };

            const handleDeleteTask = (taskId) => {
                if(!confirm("Delete this task?")) return;
                setData(prev => {
                    return prev.map(group => ({
                        ...group,
                        subActivities: group.subActivities.filter(t => t.id !== taskId)
                    })).filter(group => group.subActivities.length > 0);
                });
            };

            const handleReset = () => {
                if(confirm("Reset to default data?")) {
                    setData(DEFAULT_DATA);
                    setTeamMembers(DEFAULT_TEAM);
                }
            };

            const filteredRows = useMemo(() => {
                let allSubActivities = [];
                data.forEach(g => {
                    allSubActivities = [...allSubActivities, ...g.subActivities];
                });
                return allSubActivities.filter(item => {
                    const matchPerson = personFilter === 'All' || item.responsible === personFilter;
                    const matchCat = categoryFilter === 'All' || item.category === categoryFilter;
                    return matchPerson && matchCat;
                });
            }, [data, personFilter, categoryFilter]);

            const groupedDisplay = useMemo(() => {
                if (viewMode === 'flat') return { flat: filteredRows };
                const groups = {};
                filteredRows.forEach(row => {
                    if (!groups[row.parentActivity]) groups[row.parentActivity] = [];
                    groups[row.parentActivity].push(row);
                });
                return { groups };
            }, [filteredRows, viewMode]);

            return (
                <div className="flex flex-col h-screen">
                    <EditModal 
                        isOpen={isModalOpen || !!editingTask} 
                        onClose={() => { setIsModalOpen(false); setEditingTask(null); }} 
                        onSave={handleSaveTask}
                        onImport={handleTextImport}
                        taskToEdit={editingTask}
                        teamMembers={teamMembers}
                        onManageTeam={handleManageTeam}
                        existingGroups={existingGroups}
                        currentData={data}
                    />

                    {monitoringTask && <MonitorModal task={monitoringTask} onClose={() => setMonitoringTask(null)} onUpdate={handleUpdateStatus} />}

                    {/* Header */}
                    <header className="bg-white border-b border-slate-200 px-6 py-4 flex flex-col md:flex-row items-start md:items-center justify-between gap-4 shadow-sm z-10">
                        <div>
                            <h1 className="text-xl font-bold text-slate-900 flex items-center gap-2">
                                <CalendarIcon className="w-5 h-5 text-indigo-600" />
                                Gender Unit Work Plan 2026
                            </h1>
                            <div className="flex items-center gap-4 mt-1">
                                <p className="text-sm text-slate-500">Weekly Programme Follow-up</p>
                                <div className="h-4 w-px bg-slate-300"></div>
                                <div className="flex bg-slate-100 rounded-lg p-0.5">
                                    <button onClick={() => setTimelineMode('months')} className={`px-3 py-0.5 text-xs font-medium rounded-md transition-all ${timelineMode === 'months' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>Months</button>
                                    <button onClick={() => setTimelineMode('weeks')} className={`px-3 py-0.5 text-xs font-medium rounded-md transition-all ${timelineMode === 'weeks' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>Weeks</button>
                                </div>
                            </div>
                        </div>

                        <div className="flex flex-wrap items-center gap-3">
                            <button onClick={() => setIsModalOpen(true)} className="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 transition-colors shadow-sm">
                                <SettingsIcon className="w-4 h-4" /> Manage Data
                            </button>
                            
                            <div className="flex items-center gap-2 bg-slate-100 p-1 rounded-lg">
                                <div className="relative">
                                    <select className="appearance-none bg-white border border-slate-200 text-sm rounded-md py-1.5 pl-3 pr-8 focus:outline-none focus:ring-2 focus:ring-indigo-500" value={personFilter} onChange={(e) => setPersonFilter(e.target.value)}>
                                        <option value="All">All Staff</option>
                                        {teamMembers.map(p => <option key={p} value={p}>{p}</option>)}
                                    </select>
                                    <ChevronDownIcon className="w-3 h-3 absolute right-2.5 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none" />
                                </div>

                                <div className="relative">
                                    <select className="appearance-none bg-white border border-slate-200 text-sm rounded-md py-1.5 pl-3 pr-8 focus:outline-none focus:ring-2 focus:ring-indigo-500" value={categoryFilter} onChange={(e) => setCategoryFilter(e.target.value)}>
                                        <option value="All">All Categories</option>
                                        <option value="Coordination">Coordination</option>
                                        <option value="Technical work">Technical work</option>
                                        <option value="Workshops / meetings">Workshops</option>
                                        <option value="Reporting">Reporting</option>
                                    </select>
                                    <ChevronDownIcon className="w-3 h-3 absolute right-2.5 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none" />
                                </div>
                            </div>
                            <button onClick={handleReset} className="text-xs text-slate-400 hover:text-red-500 underline ml-2">Reset</button>
                        </div>
                    </header>

                    {/* Legend */}
                    <div className="bg-white border-b border-slate-200 px-6 py-2 flex gap-6 text-xs overflow-x-auto">
                        {Object.entries(CATEGORY_BAR_COLORS).map(([cat, colorClass]) => (
                            <div key={cat} className="flex items-center gap-2 whitespace-nowrap">
                                <span className={`w-3 h-3 rounded-full ${colorClass.replace('text-', 'bg-').replace('border-', '')}`}></span>
                                <span className="text-slate-600 font-medium">{cat}</span>
                            </div>
                        ))}
                    </div>

                    {/* Main Gantt Area */}
                    <div className="flex-1 overflow-hidden flex flex-col">
                        <div className="flex border-b border-slate-200 bg-slate-50 text-xs font-semibold text-slate-500 uppercase tracking-wider sticky top-0 z-20">
                            <div className="w-1/3 min-w-[300px] p-3 border-r border-slate-200">Activity / Sub-activity</div>
                            <div className="w-24 p-3 border-r border-slate-200 text-center">Lead</div>
                            <div className="flex-1 flex">
                                {MONTHS.map((m, i) => (
                                    <div key={m} className={`flex-1 flex flex-col border-r border-slate-200 last:border-r-0 ${i % 3 === 2 ? 'border-r-slate-300' : ''}`}>
                                        <div className="p-2 text-center border-b border-slate-100">{m}</div>
                                        {timelineMode === 'weeks' && (
                                            <div className="flex flex-1 text-[9px] text-slate-400">
                                                <div className="flex-1 text-center border-r border-slate-50">1</div>
                                                <div className="flex-1 text-center border-r border-slate-50">2</div>
                                                <div className="flex-1 text-center border-r border-slate-50">3</div>
                                                <div className="flex-1 text-center">4</div>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto">
                            {viewMode === 'grouped' ? (
                                Object.entries(groupedDisplay.groups || {}).map(([parent, subs]) => (
                                    <div key={parent} className="border-b border-slate-200 last:border-b-0">
                                        <div className="bg-slate-50 px-4 py-2 font-semibold text-sm text-slate-800 border-b border-slate-100 flex items-center sticky top-0">
                                            <FileTextIcon className="w-4 h-4 mr-2 text-indigo-500" />
                                            {parent}
                                        </div>
                                        {subs.map(task => <GanttRow key={task.id} task={task} onDelete={handleDeleteTask} onMonitor={setMonitoringTask} onEdit={setEditingTask} timelineMode={timelineMode} />)}
                                    </div>
                                ))
                            ) : (
                                filteredRows.map(task => <GanttRow key={task.id} task={task} onDelete={handleDeleteTask} onMonitor={setMonitoringTask} onEdit={setEditingTask} timelineMode={timelineMode} />)
                            )}
                            
                            {filteredRows.length === 0 && (
                                <div className="p-12 text-center text-slate-400">
                                    <FilterIcon className="w-12 h-12 mx-auto mb-3 opacity-20" />
                                    <p>No activities match your filter criteria.</p>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>